<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>ForestHopper Movement prototype 2</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(1058, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {


    game.load.image('ground', 'assets/platform.png');
    game.load.image('bg1', 'assets/TutorialBG.png');
    //game.load.spritesheet('player', 'assets/bunnyRunning.png', 46, 90, 27);
    game.load.spritesheet('player', 'assets/bunnywork.png', 46, 90, 59);
    game.load.spritesheet('bat', 'assets/bat.png', 46, 30)    


}
var player;
var platforms;
var cursors;
var bat


function create() {
    game.add.sprite(0, 0, 'bg1');
    platforms = game.add.group();
    platforms.enableBody = true;
    var ground = platforms.create(0, game.world.height - 64, 'ground');
    ground.scale.setTo(2, 2);
    ground.body.immovable = true;
    var ledge = platforms.create(800, 200, 'ground');
    ledge.body.immovable = true;
    ledge = platforms.create(450, 350, 'ground');
    ledge.body.immovable = true;


//    player = game.add.sprite(96, game.world.height - 180, 'player');
    player = game.add.sprite(96, game.world.height - 127, 'player');
    player.scale.setTo(.7, .7);
    
    game.physics.arcade.enable(player);
    
    player.body.gravity.y = 300;
    
    player.body.collideWorldBounds = true;
//    player.animations.add('left', [10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0], 20, true);
//    player.animations.add('right', [18, 19, 20, 21, 22, 23, 24, 25, 26, 27], 20, true);
//    player.animations.add('idle', [13, 12, 13, 14], 1, true);
//    player.animations.add('ascending',[13],40,true);
//    player.animations.add('doublejump',[13],10,true);
//    player.animations.add('float',[13],10,true);
//    player.animations.add('descending',[13],10,true);
    player.animations.add('left', [13, 12, 11, 10, 6, 5, 4, 3, 2, 1, 0], 20, true);
    player.animations.add('right', [22, 23, 24, 25, 26, 30, 31, 32, 33, 34, 35], 20, true);
    player.animations.add('idle', [53, 54, 55, 56, 57, 58, 59], 1, true);
    player.animations.add('ascending',[8],40,true);
    player.animations.add('doublejump',[9, 41, 42, 43, 44, 45, 46, 47, 48],10,true);
    player.animations.add('float',[7],10,true);
    player.animations.add('descending',[46],10,true);
    
    
    
    
    

    batEnemy = game.add.sprite(400, game.world.height - 300, 'bat')
    game.physics.arcade.enable(batEnemy);
    batEnemy.body.collideWorldBounds = true;
    batEnemy.animations.add('flying', [0, 1, 2, 3, 4, 5, 6], 10, true);
    
    
    
    
    
    

    cursors = game.input.keyboard.createCursorKeys();
    var canDouble=1;
}

function update() {
    batEnemy.animations.play('flying');    
    
    
    
    game.physics.arcade.collide(player, platforms);
    game.physics.arcade.collide(batEnemy, platforms);
    game.physics.arcade.overlap(player, batEnemy, enemyInteraction, null, this);
    
    
    // player, enemy, enemycords, lineofsight, speed
    lineOfSight(player, batEnemy, [400, 300], [150, 100], [50,50]);

    player.body.velocity.x = 0;

    if (cursors.left.isDown)
    {
        player.body.velocity.x = -150;
        //player.anchor.setTo(.5,.5);
        //player.scale.x =-1;
        if(player.body.velocity.y==0){
            player.animations.play('left');
        }
        if(player.body.velocity.x>=-151 && player.body.velocity.x<=151){
            dashing=0;
            console.log("Attempted to reset dash");
        }
    }

    else if (cursors.right.isDown)
    {
     player.body.velocity.x = 150;
     //player.anchor.setTo(.5,.5);
     //player.scale.x =.7;
     if(player.body.velocity.y==0){
        player.animations.play('right');
     }
     if(player.body.velocity.x>-151 && player.body.velocity.x<151){
            dashing=0;
        }
    }
    else if( player.body.velocity.x==0 && player.body.velocity.y==0)
    {
        //player.animations.stop();
        player.animations.play('idle');
    }

    if(cursors.down.isDown && dashing==0){
        player.body.velocity.y=0;
        
        if(cursors.right.isDown && dashing==0){
            player.body.velocity.x=350;
            //player.anchor.setTo(.5,.5);
            //player.scale.x =.7;
            dashing=1;
            player.animations.play('ascending');

        }else if(cursors.left.isDown && dashing==0){
            //player.anchor.setTo(.5,.5);
            //player.scale.x =-.7;
            player.body.velocity.x=-350;
            dashing=1;
            player.animations.play('ascending');
        }
    }
    
    
//    else if (cursors.A.isDown){
//        player.animations.play('right');
//        
//    }
    
    
    
    /*if (player.body.touching.down) {
         jump = 2;
         
     }
     
     if (cursors.up.isReleased && jump > 0) {
         jump--;
         player.body.velocity.y = -400;
         player.animations.play('doublejump');
     }*/
    
    cursors.up.onDown.add(jumpCheck);
    if(player.body.touching.down){
            jumpCount = 0;
            jumpHeight=1;
    }
    
    function jumpCheck() {
        if((jumpCount < 1) && (player.body.touching.down)){
            jump();
           jumpHeight=0.66;
            
        }
        if((jumpCount < 2) && (!player.body.touching.down)){
            jump();
  
        }

    }

    function jump(){
       
        jumpCount ++;
        player.body.velocity.y = -350*jumpHeight;
        player.animations.play('doublejump');
    }

    
    
    if (player.body.velocity.y >0){
        player.animations.play('descending');
    }
    

}
function enemyInteraction (player, enemy) {
        
        
 // kill player so we can no longer control the game
    player.kill();
}
function lineOfSight (player, enemy, enemyCords, enemySight, enemySpeed){
    playersXCords = player.body.x
    playersYCords = player.body.y
    enemyXCords = enemy.body.x
    enemyYCords = enemy.body.y
    xDistanceAbs = Math.abs(enemyXCords - playersXCords)
    yDistanceAbs = Math.abs(enemyYCords - playersYCords)
    xDistance = enemyXCords - playersXCords
    yDistance = enemyYCords - playersYCords
    if (xDistanceAbs <= enemySight[0] && yDistanceAbs <= enemySight[0]){
        
        
        if (xDistance <= 0 && yDistance <= 0){
            enemy.body.velocity.x = +enemySpeed[0]
            enemy.body.velocity.y = +enemySpeed[1]
        }
        else if (xDistance > 0 && yDistance > 0){
            enemy.body.velocity.x = -enemySpeed[0]
            enemy.body.velocity.y = -enemySpeed[1]
        }
        else if (xDistance <= 0 && yDistance > 0){
            enemy.body.velocity.x = +enemySpeed[0]
            enemy.body.velocity.y = -enemySpeed[1]
        }
        else if (xDistance > 0 && yDistance <= 0){
            enemy.body.velocity.x = -enemySpeed[0]
            enemy.body.velocity.y = +enemySpeed[1]
        }
    }
    else if (enemyXCords == enemyCords[0] && enemyYCords == enemyCords[1]){
        enemy.body.velocity.x = 0
        enemy.body.velocity.y = 0    
    }
    else {
        if (enemyXCords >= enemyCords[0]){
            enemy.body.velocity.x = -enemySpeed[0]
        }
        else {
            enemy.body.velocity.x = +enemySpeed[0]
        }
        if (enemyYCords >= enemyCords[1]){
            enemy.body.velocity.y = -enemySpeed[1]
        }
        else {
            enemy.body.velocity.y = +enemySpeed[1]
        }
        
    }
             
    
    
}


</script>

</body>
</html>